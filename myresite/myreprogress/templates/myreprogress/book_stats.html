{% extends "base.html" %}

{% block title %}{{ book_name }} details{% endblock %}

{% block scripts_linked %}

{% endblock %}

{% block scripts %}
{% with color_true="green" symbol_true="V" color_false="red" symbol_false="X" %}

	{% if user.is_staff %}
		<script type="text/javascript">
			//script for checkboxes
			var COLOR_TRANS = "orange";
			var SYMBOL_TRANS = "O";
			var COLOR_TRUE = "{{color_true}}";
			var SYMBOL_TRUE = "{{symbol_true}}";
			var COLOR_FALSE = "{{color_false}}";
			var SYMBOL_FALSE = "{{symbol_false}}";

			$(document).ready(function(){
				console.log("Script started");
				$(".editable_checkbox").click(function(event){
					console.log("Clicked!");//debug

					var id = $(this).attr('id');
					var parse = id.split("-");
					var page_number = parse[0];
					var property = parse[1];
					console.log(property);//debug
					console.log("tosend" + JSON.stringify({"page_number": page_number, "property": property}));//debug

					var set_checkbox = function(elem, val){
						//toggles what the checkbox looks like
						var text = elem.text().trim();
						console.log(text);

						if(val == 0)
						{
							console.log("Turning off");
							elem.css({"background-color": COLOR_FALSE});
							elem.text(SYMBOL_FALSE);
						}
						else if(val == 1)
						{
							console.log("Turning on");
							elem.css({"background-color": COLOR_TRUE});
							elem.text(SYMBOL_TRUE);
						}
						else if(val == -1)
						{
							console.log("Transition");
							elem.css({"background-color": COLOR_TRANS});
							elem.text(SYMBOL_TRANS);
						}
					};

///////////CSRF token for DJANGO
// using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
/////////END  handling CSRF token

	//set to wait trans state
	set_checkbox($(this), -1);

						$.ajax({
							url: "/api1/book/" + {{book_id}} + "/page/" + page_number + "/set_page_property",
							type: "POST",
							dataType: "Json",
							context: $(this), //Specifies the "this" value for all AJAX related callback functions; needed, cuz callbacks don't get "this" on their own.
							data: JSON.stringify({"page_number": page_number, "property": property}),
							success: function(data, status){
								console.log("Success!");//debug
								console.log(data);//debug
								set_checkbox($(this), data.value);
							},
							error: function(xhr,status,error){
								;
							}
						});
				});
			});
		</script>
	{% endif %}
{% endwith %}

{% endblock %}

{% block body %}
{% with color_true="green" symbol_true="V" color_false="red" symbol_false="X" %}

Book "{{ book_name }}" stats<br>
<table>
	<tr>
		<th>Page number</th>
		<th>sketched </th>
		<th>colored</th>
		<th>edited</th>
		<th>proofread</th>
	</tr>
	{% for page in book_pages %}
	<tr>
		{% with sketched=page.sketched colored=page.colored edited=page.edited proofread=page.proofread %}
		<td>Page {{ page.page_number }}</td>
		<td id="{{page.page_number}}-sketched" 
		class={% if user.is_staff %}"editable_checkbox"{% else %}"display_checkbox"{% endif %} 
		style="background-color: {% if sketched %}{{color_true}}{% else %}{{color_false}}{% endif %}">
		{% if sketched %}{{symbol_true}}{% else %}{{symbol_false}}{% endif %}</td>
		<td id="{{page.page_number}}-colored" 
		class={% if user.is_staff %}"editable_checkbox"{% else %}"display_checkbox"{% endif %} 
		style="background-color: {% if colored %}{{color_true}}{% else %}{{color_false}}{% endif %}">
		{% if colored %}{{symbol_true}}{% else %}{{symbol_false}}{% endif %}</td>
		<td id="{{page.page_number}}-edited" 
		class={% if user.is_staff %}"editable_checkbox"{% else %}"display_checkbox"{% endif %} 
		style="background-color: {% if edited %}{{color_true}}{% else %}{{color_false}}{% endif %}">
		{% if edited %}{{symbol_true}}{% else %}{{symbol_false}}{% endif %} </td>
		<td id="{{page.page_number}}-proofread" 
		class={% if user.is_staff %}"editable_checkbox"{% else %}"display_checkbox"{% endif %} 
		style="background-color: {% if proofread %}{{color_true}}{% else %}{{color_false}}{% endif %}">
		{% if proofread %}{{symbol_true}}{% else %}{{symbol_false}}{% endif %}</td>
		{% endwith %}
	</tr>
	{% endfor %}
</table>
{% endwith %}
{% endblock %}
